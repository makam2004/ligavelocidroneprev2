document.addEventListener('DOMContentLoaded', async () => {
  const semana = obtenerSemanaActual();
  document.getElementById('tituloSemana').textContent = `LIGA VELOCIDRONE - Semana ${semana}`;
  cargarMejoras();

  document.getElementById('btnReglamento').onclick = mostrarReglamento;
  document.getElementById('btnAlta').onclick = mostrarAlta;
  document.getElementById('overlay').onclick = cerrarPopups;
});

function obtenerSemanaActual() {
  const fecha = new Date();
  const inicio = new Date(fecha.getFullYear(), 0, 1);
  const dias = Math.floor((fecha - inicio) / 86400000);
  return Math.ceil((dias + inicio.getDay() + 1) / 7);
}

async function mostrarReglamento() {
  const res = await fetch('reglamento.txt');
  const texto = await res.text();
  document.getElementById('popupTexto').innerHTML = `<pre>${texto}</pre>`;
  document.getElementById('popup').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
}

function mostrarAlta() {
  document.getElementById('popupAlta').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
  if (window.hcaptcha) hcaptcha.reset();
}

function cerrarPopups() {
  document.getElementById('popup').style.display = 'none';
  document.getElementById('popupAlta').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('mensajeAlta').textContent = '';
  document.getElementById('nombreJugador').value = '';
}

async function registrarJugador(event) {
  event.preventDefault();
  const nombre = document.getElementById('nombreJugador').value.trim();
  const token = document.querySelector('[name="h-captcha-response"]')?.value;
  const mensaje = document.getElementById('mensajeAlta');

  if (!nombre || !token) {
    mensaje.textContent = 'Por favor, completa el captcha y el nombre.';
    return;
  }

  try {
    const res = await fetch('/api/alta-jugador', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nombre, token })
    });

    const json = await res.json();
    if (res.ok) {
      mensaje.textContent = 'Jugador registrado correctamente.';
      hcaptcha.reset();
    } else {
      mensaje.textContent = json?.error || 'Error al registrar.';
    }
  } catch (err) {
    mensaje.textContent = 'Error al conectar con el servidor.';
  }
}

async function cargarMejoras() {
  const track1 = document.getElementById('track1');
  const track2 = document.getElementById('track2');
  track1.innerHTML = track2.innerHTML = '<p>⏳ Leyendo resultados...</p>';

  try {
    const res = await fetch('/api/tiempos-mejorados');
    const data = await res.json();

    const puntos = [10, 9, 8, 7, 6, 5, 4, 3, 2];
    const ranking = {};

    [track1, track2].forEach((trackDiv, index) => {
      const pista = data[index];
      const div = document.createElement('div');

      const h3 = document.createElement('h3');
      h3.innerHTML = `<span style="color:red">${pista.pestaña}</span><br>${pista.escenario} - ${pista.pista}`;
      div.appendChild(h3);

      const tabla = document.createElement('table');
      tabla.innerHTML = `
        <thead><tr><th>Ranking</th><th>Piloto</th><th>Tiempo</th></tr></thead>
        <tbody>
          ${pista.resultados.map((r, i) => {
            const puntosObtenidos = i < puntos.length ? puntos[i] : 1;
            ranking[r.jugador] = (ranking[r.jugador] || 0) + puntosObtenidos;
            return `<tr><td>${i + 1}</td><td>${r.jugador}</td><td>${r.tiempo.toFixed(2)} s</td></tr>`;
          }).join('')}
        </tbody>
      `;
      div.appendChild(tabla);
      trackDiv.innerHTML = '';
      trackDiv.appendChild(div);
    });

    const entries = Object.entries(ranking).sort((a, b) => b[1] - a[1]);
    document.querySelector('#rankingSemanal .resultado').innerHTML =
      `<table><thead><tr><th>#</th><th>Piloto</th><th>Puntos</th></tr></thead><tbody>` +
      entries.map(([jugador, puntos], i) => `<tr><td>${i + 1}</td><td>${jugador}</td><td>${puntos}</td></tr>`).join('') +
      `</tbody></table>`;
  } catch (err) {
    console.error('❌ Error capturado en cargarMejoras:', err);
    track1.innerHTML = track2.innerHTML = '<p>Error al cargar los resultados.</p>';
  }
}
